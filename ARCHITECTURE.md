# Airdrop é¡¹ç›®æ¶æ„æ–‡æ¡£

> æœ¬æ–‡æ¡£æ—¨åœ¨å¸®åŠ© AI å’Œå¼€å‘è€…å¿«é€Ÿç†è§£é¡¹ç›®çš„ä»£ç ç»“æ„ã€æ¨¡å—èŒè´£å’Œä¸šåŠ¡é€»è¾‘ã€‚

## ğŸ“‹ ç›®å½•

1. [é¡¹ç›®æ¦‚è§ˆ](#é¡¹ç›®æ¦‚è§ˆ)
2. [æŠ€æœ¯æ ˆ](#æŠ€æœ¯æ ˆ)
3. [Crate æ¶æ„](#crate-æ¶æ„)
4. [æ ¸å¿ƒæ•°æ®ç»“æ„](#æ ¸å¿ƒæ•°æ®ç»“æ„)
5. [ä¸šåŠ¡é€»è¾‘æµç¨‹](#ä¸šåŠ¡é€»è¾‘æµç¨‹)
6. [æ¨¡å—ä¾èµ–å…³ç³»](#æ¨¡å—ä¾èµ–å…³ç³»)
7. [è®¾è®¡æ¨¡å¼](#è®¾è®¡æ¨¡å¼)
8. [æµ‹è¯•ä¸ç¤ºä¾‹](#æµ‹è¯•ä¸ç¤ºä¾‹)
9. [é¡¹ç›®çŠ¶æ€](#é¡¹ç›®çŠ¶æ€)

---

## é¡¹ç›®æ¦‚è§ˆ

**é¡¹ç›®åç§°**: Airdrop
**é¡¹ç›®ç±»å‹**: å±€åŸŸç½‘è®¾å¤‡å‘ç°ä¸æ–‡ä»¶ä¼ è¾“ç³»ç»Ÿ
**è¯­è¨€ç‰ˆæœ¬**: Rust Edition 2024
**æ¶æ„é£æ ¼**: Multi-crate Workspace + å¼‚æ­¥äº‹ä»¶é©±åŠ¨

### æ ¸å¿ƒåŠŸèƒ½

- **è®¾å¤‡å‘ç°**: åŸºäº mDNS/UDP å¤šæ’­åè®®è‡ªåŠ¨å‘ç°å±€åŸŸç½‘å†…çš„è®¾å¤‡
- **ä¼šè¯ç®¡ç†**: è¿½è¸ªè®¾å¤‡çš„åœ¨çº¿/ç¦»çº¿çŠ¶æ€å’Œç”Ÿå‘½å‘¨æœŸ
- **æ–‡ä»¶ä¼ è¾“**: (å¾…å®ç°) è®¾å¤‡é—´çš„æ–‡ä»¶ä¼ è¾“åŠŸèƒ½
- **å‘½ä»¤è¡Œå·¥å…·**: æä¾›ç”¨æˆ·äº¤äº’çš„ CLI æ¥å£
- **å®ˆæŠ¤è¿›ç¨‹**: åå°è¿è¡Œçš„æœåŠ¡è¿›ç¨‹

---

## æŠ€æœ¯æ ˆ

| ç»„ä»¶ | æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|------|
| å¼‚æ­¥è¿è¡Œæ—¶ | Tokio | 1.x | äº‹ä»¶å¾ªç¯ã€å¹¶å‘ä»»åŠ¡ç®¡ç† |
| ç½‘ç»œå±‚ | socket2 | 0.6.1 | UDP å¤šæ’­åº•å±‚å¥—æ¥å­—æ“ä½œ |
| è®¾å¤‡æ ‡è¯† | uuid | 1.x | ç”Ÿæˆè®¾å¤‡å”¯ä¸€ ID |
| CLI è§£æ | clap | 4.x | å‘½ä»¤è¡Œå‚æ•°è§£æ |
| æ—¥å¿—ç³»ç»Ÿ | tracing | 0.1 | ç»“æ„åŒ–æ—¥å¿— |
| æ—¥å¿—è¾“å‡º | tracing-subscriber | 0.3 | æ—¥å¿—è®¢é˜…å’Œæ ¼å¼åŒ– |
| åºåˆ—åŒ– | serde | 1.x | æ•°æ®åºåˆ—åŒ–/ååºåˆ—åŒ– |
| é…ç½®è§£æ | toml | 0.8 | é…ç½®æ–‡ä»¶è§£æ |

---

## Crate æ¶æ„

é¡¹ç›®é‡‡ç”¨ Rust Workspace ç»“æ„ï¼Œåˆ†ä¸º 5 ä¸ªç‹¬ç«‹çš„ crateï¼š

```
airdrop/
â”œâ”€â”€ Cargo.toml (workspace æ ¹é…ç½®)
â”œâ”€â”€ src/main.rs (å…¥å£å ä½ç¬¦)
â””â”€â”€ crates/
    â”œâ”€â”€ discovery/    (è®¾å¤‡å‘ç°å±‚)
    â”œâ”€â”€ session/      (ä¼šè¯ç®¡ç†å±‚)
    â”œâ”€â”€ transfer/     (æ–‡ä»¶ä¼ è¾“å±‚ - å¾…å®ç°)
    â”œâ”€â”€ cli/          (å‘½ä»¤è¡Œæ¥å£)
    â””â”€â”€ daemon/       (å®ˆæŠ¤è¿›ç¨‹)
```

### 1. Discovery Crate

**è·¯å¾„**: `crates/discovery/`
**èŒè´£**: å®ç°åŸºäº mDNS çš„å±€åŸŸç½‘è®¾å¤‡è‡ªåŠ¨å‘ç°

#### æ ¸å¿ƒç»„ä»¶

**Peer ç»“æ„ä½“** - è¡¨ç¤ºç½‘ç»œä¸Šçš„ä¸€ä¸ªè®¾å¤‡
```rust
pub struct Peer {
    pub id: Uuid,           // è®¾å¤‡å”¯ä¸€æ ‡è¯†ç¬¦
    pub name: String,       // è®¾å¤‡åç§° (ç”¨æˆ·å¯è¯»)
    pub addr: SocketAddr,   // è®¾å¤‡ç½‘ç»œåœ°å€ (IP:Port)
}
```

**Discovery ç»“æ„ä½“** - è®¾å¤‡å‘ç°ç®¡ç†å™¨
```rust
pub struct Discovery {
    pub device_id: Uuid,                // æœ¬åœ°è®¾å¤‡ ID
    pub device_name: String,            // æœ¬åœ°è®¾å¤‡åç§°
    pub rx: mpsc::Receiver<Peer>,      // æ¥æ”¶å‘ç°çš„ Peer çš„é€šé“
}
```

#### å·¥ä½œæœºåˆ¶

**1. å¹¿æ’­ä»»åŠ¡ (broadcast_task)**
- æ¯ 5 ç§’å‘å¤šæ’­ç»„ `224.0.0.251:5353` å‘é€å¹¿æ’­
- æ¶ˆæ¯æ ¼å¼: `DISCOVERY:{device_name}`
- ä½¿ç”¨ `tokio::spawn` å¼‚æ­¥æ‰§è¡Œ

**2. ç›‘å¬ä»»åŠ¡ (listen_task)**
- åˆ›å»º UDP å¥—æ¥å­—å¹¶åŠ å…¥å¤šæ’­ç»„
- å¯ç”¨ `SO_REUSEADDR` å’Œ `SO_REUSEPORT` (æ”¯æŒå¤šè¿›ç¨‹ç›‘å¬)
- æ¥æ”¶å…¶ä»–è®¾å¤‡çš„å¹¿æ’­æ¶ˆæ¯
- è§£ææ¶ˆæ¯å¹¶é€šè¿‡ MPSC é€šé“å‘é€ `Peer` å¯¹è±¡

#### å…³é”®ä»£ç è·¯å¾„

- ä¸»å®ç°: `crates/discovery/src/lib.rs`
- æµ‹è¯•ç¤ºä¾‹: `crates/discovery/examples/test_discovery.rs`

---

### 2. Session Crate

**è·¯å¾„**: `crates/session/`
**èŒè´£**: ç®¡ç†è®¾å¤‡ä¼šè¯çš„ç”Ÿå‘½å‘¨æœŸå’ŒçŠ¶æ€

#### æ¨¡å—ç»“æ„

| æ–‡ä»¶ | èŒè´£ |
|------|------|
| `session.rs` | å®šä¹‰ Session å’Œ PeerState æ•°æ®æ¨¡å‹ |
| `manager.rs` | å®ç° SessionManager æ ¸å¿ƒé€»è¾‘ |
| `event.rs` | å®šä¹‰ SessionEvent äº‹ä»¶ç±»å‹ |
| `lib.rs` | æ¨¡å—å¯¼å‡º |

#### æ ¸å¿ƒç»„ä»¶

**PeerState æšä¸¾** - è®¾å¤‡çŠ¶æ€
```rust
#[derive(Clone, Debug)]
pub enum PeerState {
    online,   // è®¾å¤‡åœ¨çº¿
    offline,  // è®¾å¤‡ç¦»çº¿
}
```

**Session ç»“æ„ä½“** - å•ä¸ªè®¾å¤‡çš„ä¼šè¯ä¿¡æ¯
```rust
pub struct Session {
    pub peer: Peer,           // å…³è”çš„ Peer å¯¹è±¡
    pub state: PeerState,     // å½“å‰çŠ¶æ€
    pub last_seen: Instant,   // æœ€åä¸€æ¬¡è¢«å‘ç°çš„æ—¶é—´æˆ³
}
```

**SessionManager ç»“æ„ä½“** - ä¼šè¯ç®¡ç†å™¨
```rust
pub struct SessionManager {
    sessions: HashMap<String, Session>,  // æŒ‰è®¾å¤‡åç§°ç´¢å¼•çš„ä¼šè¯é›†åˆ
    tx: mpsc::Sender<SessionEvent>,      // äº‹ä»¶å‘é€é€šé“
}
```

**SessionEvent æšä¸¾** - ä¼šè¯äº‹ä»¶
```rust
#[derive(Debug)]
pub enum SessionEvent {
    PeerOnline(Peer),   // è®¾å¤‡ä¸Šçº¿äº‹ä»¶
    PeerOffline(Peer),  // è®¾å¤‡ç¦»çº¿äº‹ä»¶
}
```

#### å…³é”®æ–¹æ³•

**on_peer_discovered(peer: Peer)**
- å½“ Discovery å‘ç°æ–°è®¾å¤‡æ—¶è°ƒç”¨
- é€»è¾‘:
  - å¦‚æœè®¾å¤‡å·²å­˜åœ¨: æ›´æ–° `last_seen` æ—¶é—´ï¼Œæ ‡è®°ä¸º `online`
  - å¦‚æœè®¾å¤‡ä¸å­˜åœ¨: åˆ›å»ºæ–° `Session`ï¼Œå‘é€ `PeerOnline` äº‹ä»¶

**reap_offline(timeout: Duration)**
- å®šæœŸè°ƒç”¨ä»¥æ¸…ç†è¶…æ—¶çš„ç¦»çº¿è®¾å¤‡
- é€»è¾‘:
  - éå†æ‰€æœ‰ `Session`
  - æ£€æŸ¥ `last_seen` æ˜¯å¦è¶…è¿‡ `timeout`
  - ç§»é™¤è¶…æ—¶è®¾å¤‡ï¼Œå‘é€ `PeerOffline` äº‹ä»¶

#### å…³é”®ä»£ç è·¯å¾„

- ä¼šè¯æ¨¡å‹: `crates/session/src/session.rs`
- ç®¡ç†å™¨å®ç°: `crates/session/src/manager.rs`
- äº‹ä»¶å®šä¹‰: `crates/session/src/event.rs`
- å®Œæ•´ç¤ºä¾‹: `crates/session/examples/test_session.rs`

---

### 3. Transfer Crate

**è·¯å¾„**: `crates/transfer/`
**èŒè´£**: å®ç°è®¾å¤‡é—´çš„æ–‡ä»¶ä¼ è¾“åŠŸèƒ½

**å½“å‰çŠ¶æ€**: â³ å¾…å®ç° (ä»…æœ‰å ä½ç¬¦ä»£ç )

**é¢„æœŸåŠŸèƒ½**:
- æ–‡ä»¶å‘é€/æ¥æ”¶
- ä¼ è¾“è¿›åº¦è¿½è¸ª
- æ–­ç‚¹ç»­ä¼ 
- é”™è¯¯æ¢å¤æœºåˆ¶
- å¸¦å®½ç®¡ç†

---

### 4. CLI Crate

**è·¯å¾„**: `crates/cli/`
**èŒè´£**: æä¾›å‘½ä»¤è¡Œç”¨æˆ·æ¥å£

#### å‘½ä»¤ç»“æ„

```rust
#[derive(Parser)]
struct Cli {
    command: Commands,
}

#[derive(Subcommand)]
enum Commands {
    Start,   // å¯åŠ¨å®ˆæŠ¤è¿›ç¨‹
    Status,  // æŸ¥çœ‹è¿è¡ŒçŠ¶æ€
    Stop,    // åœæ­¢å®ˆæŠ¤è¿›ç¨‹
}
```

#### ä½¿ç”¨ç¤ºä¾‹

```bash
# å¯åŠ¨æœåŠ¡
airdrop start

# æŸ¥çœ‹çŠ¶æ€
airdrop status

# åœæ­¢æœåŠ¡
airdrop stop
```

#### æœªæ¥æ‰©å±•

- é›†æˆ systemd (Linux)
- é›†æˆ launchd (macOS)
- æ”¯æŒæ›´å¤šç®¡ç†å‘½ä»¤

---

### 5. Daemon Crate

**è·¯å¾„**: `crates/daemon/`
**èŒè´£**: åå°å®ˆæŠ¤è¿›ç¨‹ï¼Œåè°ƒå„ä¸ªæ¨¡å—

#### å½“å‰å®ç°

```rust
#[tokio::main]
async fn main() {
    tracing_subscriber::fmt::init();  // åˆå§‹åŒ–æ—¥å¿—ç³»ç»Ÿ

    info!("airdropd starting....");

    // ä¸»äº‹ä»¶å¾ªç¯
    loop {
        tokio::time::sleep(Duration::from_secs(60)).await;
        info!("airdropd alive");  // å¿ƒè·³æ—¥å¿—
    }
}
```

#### é¢„æœŸåŠŸèƒ½

- æ•´åˆ Discovery + Session æ¨¡å—
- å¤„ç† SessionEvent äº‹ä»¶
- å®šæœŸè°ƒç”¨ `reap_offline()`
- é…ç½®æ–‡ä»¶ç®¡ç† (TOML)
- IPC ä¸ CLI é€šä¿¡

---

## æ ¸å¿ƒæ•°æ®ç»“æ„

### å…³é”®ç±»å‹æ±‡æ€»

| ç±»å‹ | æ‰€å± Crate | æè¿° | å­—æ®µ |
|------|-----------|------|------|
| `Peer` | discovery | ç½‘ç»œè®¾å¤‡è¡¨ç¤º | id, name, addr |
| `Discovery` | discovery | è®¾å¤‡å‘ç°ç®¡ç†å™¨ | device_id, device_name, rx |
| `Session` | session | è®¾å¤‡ä¼šè¯çŠ¶æ€ | peer, state, last_seen |
| `SessionManager` | session | ä¼šè¯é›†åˆç®¡ç† | sessions (HashMap), tx |
| `SessionEvent` | session | ä¼šè¯äº‹ä»¶ | PeerOnline/PeerOffline |
| `PeerState` | session | è®¾å¤‡çŠ¶æ€æšä¸¾ | online/offline |

### æ•°æ®æµé€šé“

```
Discovery.rx: Receiver<Peer>
   â””â”€> æ¥æ”¶ä»ç½‘ç»œå‘ç°çš„ Peer å¯¹è±¡

SessionManager.tx: Sender<SessionEvent>
   â””â”€> å‘é€ä¼šè¯çŠ¶æ€å˜åŒ–äº‹ä»¶ (PeerOnline/PeerOffline)
```

---

## ä¸šåŠ¡é€»è¾‘æµç¨‹

### 1. è®¾å¤‡å‘ç°æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Discovery::new(device_name)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                     â”‚
â”‚ 1. ç”Ÿæˆæœ¬åœ° device_id (UUID)                        â”‚
â”‚                                                     â”‚
â”‚ 2. å¯åŠ¨ broadcast_task (tokio::spawn)               â”‚
â”‚    â””â”€> æ¯ 5 ç§’å‘é€ "DISCOVERY:{device_name}"         â”‚
â”‚        åˆ°å¤šæ’­ç»„ 224.0.0.251:5353                     â”‚
â”‚                                                     â”‚
â”‚ 3. å¯åŠ¨ listen_task (tokio::spawn)                  â”‚
â”‚    â””â”€> ç›‘å¬å¤šæ’­ç»„ 224.0.0.251:5353                   â”‚
â”‚    â””â”€> æ¥æ”¶ "DISCOVERY:{name}" æ¶ˆæ¯                  â”‚
â”‚    â””â”€> è§£æå‘é€è€…åœ°å€                                â”‚
â”‚    â””â”€> åˆ›å»º Peer å¯¹è±¡                                â”‚
â”‚    â””â”€> é€šè¿‡ tx.send(peer) å‘é€åˆ° MPSC é€šé“          â”‚
â”‚                                                     â”‚
â”‚ 4. è¿”å› Discovery å®ä¾‹ (å« rx: Receiver<Peer>)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. ä¼šè¯ç®¡ç†æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SessionManager::new(event_tx)                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                     â”‚
â”‚ 1. åˆ›å»ºç©ºçš„ HashMap<String, Session>                â”‚
â”‚                                                     â”‚
â”‚ 2. ä¿å­˜ event_tx ç”¨äºå‘é€äº‹ä»¶                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SessionManager::on_peer_discovered(peer)            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                     â”‚
â”‚ if sessions.contains_key(&peer.name):               â”‚
â”‚   â”œâ”€> æ›´æ–° session.last_seen = Instant::now()      â”‚
â”‚   â””â”€> è®¾ç½® session.state = PeerState::online       â”‚
â”‚                                                     â”‚
â”‚ else:                                               â”‚
â”‚   â”œâ”€> åˆ›å»ºæ–° Session {                              â”‚
â”‚   â”‚     peer,                                       â”‚
â”‚   â”‚     state: PeerState::online,                  â”‚
â”‚   â”‚     last_seen: Instant::now(),                 â”‚
â”‚   â”‚   }                                             â”‚
â”‚   â”œâ”€> sessions.insert(peer.name, session)          â”‚
â”‚   â””â”€> tx.send(SessionEvent::PeerOnline(peer))      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SessionManager::reap_offline(timeout)               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                     â”‚
â”‚ 1. è·å–å½“å‰æ—¶é—´ now = Instant::now()                 â”‚
â”‚                                                     â”‚
â”‚ 2. éå† sessions:                                   â”‚
â”‚    for (name, session) in &sessions:                â”‚
â”‚      if now - session.last_seen > timeout:          â”‚
â”‚        â””â”€> æ ‡è®°ä¸ºå¾…ç§»é™¤                             â”‚
â”‚                                                     â”‚
â”‚ 3. ç§»é™¤è¶…æ—¶è®¾å¤‡:                                    â”‚
â”‚    for name in to_remove:                           â”‚
â”‚      â”œâ”€> let session = sessions.remove(&name)       â”‚
â”‚      â””â”€> tx.send(SessionEvent::PeerOffline(peer))  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. å®Œæ•´äº‹ä»¶å¾ªç¯ (é¢„æœŸåœ¨ Daemon ä¸­å®ç°)

```rust
// ä¼ªä»£ç ç¤ºä¾‹
async fn main() {
    // 1. åˆå§‹åŒ–ç»„ä»¶
    let mut discovery = Discovery::new("MyDevice");
    let (event_tx, event_rx) = mpsc::channel(100);
    let mut session_manager = SessionManager::new(event_tx);

    // 2. ä¸»äº‹ä»¶å¾ªç¯
    loop {
        tokio::select! {
            // ä» Discovery æ¥æ”¶æ–°å‘ç°çš„ Peer
            Some(peer) = discovery.rx.recv() => {
                session_manager.on_peer_discovered(peer);
            }

            // ä» SessionManager æ¥æ”¶çŠ¶æ€å˜åŒ–äº‹ä»¶
            Some(event) = event_rx.recv() => {
                match event {
                    SessionEvent::PeerOnline(peer) => {
                        println!("è®¾å¤‡ä¸Šçº¿: {}", peer.name);
                        // å¯ä»¥è§¦å‘ UI æ›´æ–°æˆ–å…¶ä»–é€»è¾‘
                    }
                    SessionEvent::PeerOffline(peer) => {
                        println!("è®¾å¤‡ç¦»çº¿: {}", peer.name);
                    }
                }
            }

            // å®šæœŸæ¸…ç†ç¦»çº¿è®¾å¤‡ (æ¯ 5 ç§’)
            _ = tokio::time::sleep(Duration::from_secs(5)) => {
                session_manager.reap_offline(Duration::from_secs(30));
            }
        }
    }
}
```

---

## æ¨¡å—ä¾èµ–å…³ç³»

### ä¾èµ–å±‚çº§

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         CLI Crate                       â”‚  (ç”¨æˆ·æ¥å£å±‚)
â”‚   å‘½ä»¤: start / status / stop            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Daemon Crate                    â”‚  (åè°ƒå±‚)
â”‚   â€¢ äº‹ä»¶å¾ªç¯åè°ƒ                         â”‚
â”‚   â€¢ æ—¥å¿—ç®¡ç†                             â”‚
â”‚   â€¢ é…ç½®ç®¡ç†                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
               â–¼              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Session Crate   â”‚  â”‚  Transfer Crate  â”‚  (ä¸šåŠ¡é€»è¾‘å±‚)
â”‚  â€¢ ä¼šè¯ç®¡ç†      â”‚  â”‚  â€¢ æ–‡ä»¶ä¼ è¾“      â”‚
â”‚  â€¢ çŠ¶æ€è¿½è¸ª      â”‚  â”‚  (å¾…å®ç°)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ ä¾èµ–
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Discovery Crate                 â”‚  (åŸºç¡€å±‚)
â”‚   â€¢ UDP å¤šæ’­                             â”‚
â”‚   â€¢ è®¾å¤‡å‘ç°                             â”‚
â”‚   â€¢ Peer å®šä¹‰                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Cargo ä¾èµ–é…ç½®

**Session â†’ Discovery**
```toml
# crates/session/Cargo.toml
[dependencies]
discovery = { path = "../discovery" }
```

---

## è®¾è®¡æ¨¡å¼

### 1. äº‹ä»¶é©±åŠ¨æ¶æ„ (Event-Driven Architecture)

- **é€šä¿¡æœºåˆ¶**: ä½¿ç”¨ Tokio MPSC é€šé“ä¼ é€’äº‹ä»¶
- **è§£è€¦ä¼˜åŠ¿**: å„æ¨¡å—é€šè¿‡äº‹ä»¶é€šä¿¡ï¼Œé™ä½è€¦åˆåº¦
- **å¼‚æ­¥å‹å¥½**: éé˜»å¡çš„æ¶ˆæ¯ä¼ é€’

**ç¤ºä¾‹**:
```rust
// Discovery å‘é€ Peer äº‹ä»¶
tx.send(peer).await.ok();

// SessionManager å‘é€ SessionEvent
self.tx.send(SessionEvent::PeerOnline(peer)).await.ok();
```

### 2. çŠ¶æ€æœºæ¨¡å¼ (State Machine)

- **çŠ¶æ€å®šä¹‰**: `PeerState::online` / `PeerState::offline`
- **çŠ¶æ€è½¬ç§»**: åŸºäºæ—¶é—´æˆ³ (`last_seen`) è§¦å‘
- **çŠ¶æ€è¿½è¸ª**: æ¯ä¸ª Session ç»´æŠ¤ç‹¬ç«‹çŠ¶æ€

**è½¬ç§»æ¡ä»¶**:
```
online â†’ offline: å½“ (now - last_seen) > timeout
offline â†’ online: å½“é‡æ–°æ”¶åˆ° Peer å‘ç°äº‹ä»¶
```

### 3. å¤šä»»åŠ¡å¹¶å‘æ¨¡å¼ (Concurrent Tasks)

- **ä»»åŠ¡éš”ç¦»**: ä½¿ç”¨ `tokio::spawn` åˆ›å»ºç‹¬ç«‹ä»»åŠ¡
- **ä»»åŠ¡ç¤ºä¾‹**:
  - `broadcast_task`: å‘¨æœŸæ€§å¹¿æ’­
  - `listen_task`: æŒç»­ç›‘å¬ç½‘ç»œ
  - ä¸»äº‹ä»¶å¾ªç¯: ä½¿ç”¨ `tokio::select!` å¤šè·¯å¤ç”¨

### 4. åˆ†å±‚æ¶æ„ (Layered Architecture)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¡¨ç¤ºå±‚ (Presentation Layer)          â”‚  CLI
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  åº”ç”¨å±‚ (Application Layer)           â”‚  Daemon
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ä¸šåŠ¡é€»è¾‘å±‚ (Business Logic Layer)    â”‚  Session, Transfer
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  åŸºç¡€è®¾æ–½å±‚ (Infrastructure Layer)    â”‚  Discovery
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æµ‹è¯•ä¸ç¤ºä¾‹

### ç¤ºä¾‹ç¨‹åº

#### 1. test_discovery

**è·¯å¾„**: `crates/discovery/examples/test_discovery.rs`

**è¿è¡Œå‘½ä»¤**:
```bash
cargo run --example test_discovery -p discovery
```

**åŠŸèƒ½**: æ¼”ç¤ºåŸºç¡€çš„è®¾å¤‡å‘ç°åŠŸèƒ½
- å¯åŠ¨ Discovery æœåŠ¡
- æ¥æ”¶å¹¶æ‰“å°å‘ç°çš„è®¾å¤‡
- è®¡æ•°å‘ç°çš„è®¾å¤‡æ•°é‡

---

#### 2. test_session

**è·¯å¾„**: `crates/session/examples/test_session.rs`

**è¿è¡Œå‘½ä»¤**:
```bash
cargo run --example test_session -p session
```

**åŠŸèƒ½**: æ¼”ç¤ºå®Œæ•´çš„ Discovery + SessionManager é›†æˆ
- å¯åŠ¨è®¾å¤‡å‘ç°
- ç®¡ç†è®¾å¤‡ä¼šè¯
- å¤„ç†ä¸Šçº¿/ç¦»çº¿äº‹ä»¶
- å®šæœŸæ¸…ç†ç¦»çº¿è®¾å¤‡
- æ¯ 10 ç§’æ‰“å°ç»Ÿè®¡ä¿¡æ¯

**æ ¸å¿ƒé€»è¾‘**:
```rust
loop {
    tokio::select! {
        // æ¥æ”¶å‘ç°çš„ Peer
        Some(peer) = discovery.rx.recv() => {
            session_manager.on_peer_discovered(peer).await;
        }

        // å¤„ç†ä¼šè¯äº‹ä»¶
        Some(event) = event_rx.recv() => {
            match event {
                SessionEvent::PeerOnline(peer) => { /* ... */ }
                SessionEvent::PeerOffline(peer) => { /* ... */ }
            }
        }

        // å®šæœŸæ¸…ç†
        _ = tokio::time::sleep(Duration::from_secs(5)) => {
            session_manager.reap_offline(Duration::from_secs(30)).await;
        }
    }
}
```

---

## é¡¹ç›®çŠ¶æ€

### å·²å®ŒæˆåŠŸèƒ½ âœ…

| æ¨¡å— | åŠŸèƒ½ | å®Œæˆåº¦ |
|------|------|--------|
| Discovery | è®¾å¤‡å‘ç° | ğŸŸ¢ å®Œæ•´å®ç° |
| Discovery | UDP å¤šæ’­é€šä¿¡ | ğŸŸ¢ å®Œæ•´å®ç° |
| Session | ä¼šè¯ç®¡ç†æ ¸å¿ƒé€»è¾‘ | ğŸŸ¢ å®Œæ•´å®ç° |
| Session | åœ¨çº¿/ç¦»çº¿æ£€æµ‹ | ğŸŸ¢ å®Œæ•´å®ç° |
| Session | äº‹ä»¶ç³»ç»Ÿ | ğŸŸ¢ å®Œæ•´å®ç° |
| CLI | å‘½ä»¤æ¡†æ¶ | ğŸŸ¡ åŸºç¡€æ¡†æ¶å®Œæˆ |
| Daemon | ä¸»å¾ªç¯æ¡†æ¶ | ğŸŸ¡ åŸºç¡€æ¡†æ¶å®Œæˆ |

### å¾…å®ç°åŠŸèƒ½ â³

| æ¨¡å— | åŠŸèƒ½ | ä¼˜å…ˆçº§ |
|------|------|--------|
| Transfer | æ–‡ä»¶ä¼ è¾“åè®® | ğŸ”´ é«˜ |
| Transfer | è¿›åº¦è¿½è¸ª | ğŸŸ¡ ä¸­ |
| Daemon | æ¨¡å—é›†æˆ | ğŸ”´ é«˜ |
| Daemon | é…ç½®ç®¡ç† | ğŸŸ¡ ä¸­ |
| CLI | ç³»ç»Ÿé›†æˆ (systemd/launchd) | ğŸŸ¡ ä¸­ |
| å…¨å±€ | é”™è¯¯å¤„ç† | ğŸ”´ é«˜ |
| å…¨å±€ | å®‰å…¨é€šä¿¡ (TLS/åŠ å¯†) | ğŸŸ¡ ä¸­ |
| å…¨å±€ | è®¤è¯æœºåˆ¶ | ğŸŸ¡ ä¸­ |

### æŠ€æœ¯å€ºåŠ¡

1. **é”™è¯¯å¤„ç†**: å½“å‰ä½¿ç”¨ `.ok()` å¿½ç•¥é”™è¯¯ï¼Œéœ€è¦å®Œå–„é”™è¯¯ä¼ æ’­
2. **é…ç½®ç®¡ç†**: Daemon ä¾èµ–äº† TOML ä½†æœªå®ç°é…ç½®åŠ è½½
3. **æµ‹è¯•è¦†ç›–**: ç¼ºå°‘å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•
4. **æ–‡æ¡£**: ä»£ç æ³¨é‡Šéœ€è¦å®Œå–„

---

## æ‰©å±•æŒ‡å—

### å¦‚ä½•æ·»åŠ æ–°åŠŸèƒ½

#### 1. æ‰©å±• Discovery åè®®

å¦‚éœ€æ”¯æŒæ›´å¤šè®¾å¤‡ä¿¡æ¯ (å¦‚ OS ç‰ˆæœ¬ã€IP åˆ—è¡¨):
- ä¿®æ”¹ `Peer` ç»“æ„ä½“æ·»åŠ å­—æ®µ
- æ›´æ–°å¹¿æ’­æ¶ˆæ¯æ ¼å¼ (è€ƒè™‘ä½¿ç”¨ JSON æˆ– Protocol Buffers)
- ä¿®æ”¹è§£æé€»è¾‘

#### 2. å®ç° Transfer æ¨¡å—

å»ºè®®æ­¥éª¤:
1. å®šä¹‰ä¼ è¾“åè®® (TCP/QUIC)
2. å®ç°æ–‡ä»¶å…ƒä¿¡æ¯äº¤æ¢
3. å®ç°æ•°æ®ä¼ è¾“é€»è¾‘
4. æ·»åŠ è¿›åº¦å›è°ƒ
5. å®ç°æ–­ç‚¹ç»­ä¼ 

#### 3. é›†æˆåˆ° Daemon

åœ¨ `daemon/src/main.rs` ä¸­:
1. åˆå§‹åŒ– Discovery
2. åˆå§‹åŒ– SessionManager
3. åœ¨ `tokio::select!` ä¸­å¤„ç†äº‹ä»¶
4. æ·»åŠ é…ç½®æ–‡ä»¶æ”¯æŒ

#### 4. å®Œå–„ CLI

æ·»åŠ æ›´å¤šå­å‘½ä»¤:
```rust
enum Commands {
    Start,
    Stop,
    Status,
    Send { file: PathBuf, to: String },  // å‘é€æ–‡ä»¶
    List,                                // åˆ—å‡ºåœ¨çº¿è®¾å¤‡
}
```

---

## æ¶æ„ä¼˜åŠ¿

1. **æ¨¡å—åŒ–è®¾è®¡**: å„ crate èŒè´£æ˜ç¡®ï¼Œæ˜“äºæµ‹è¯•å’Œç»´æŠ¤
2. **å¼‚æ­¥ä¼˜å…ˆ**: å……åˆ†åˆ©ç”¨ Tokio çš„å¼‚æ­¥èƒ½åŠ›ï¼Œé«˜æ•ˆå¤„ç†å¹¶å‘
3. **äº‹ä»¶é©±åŠ¨**: è§£è€¦æ¨¡å—é—´é€šä¿¡ï¼Œæ˜“äºæ‰©å±•
4. **è·¨å¹³å°**: ä½¿ç”¨ Rust æ ‡å‡†åº“å’Œè·¨å¹³å°åº“ï¼Œæ”¯æŒ Linux/macOS/Windows
5. **ç±»å‹å®‰å…¨**: åˆ©ç”¨ Rust ç±»å‹ç³»ç»Ÿå‡å°‘è¿è¡Œæ—¶é”™è¯¯

---

## å‚è€ƒèµ„æ–™

### ç›¸å…³ RFC å’Œæ ‡å‡†

- [RFC 6762](https://datatracker.ietf.org/doc/html/rfc6762) - mDNS åè®®
- [RFC 1112](https://datatracker.ietf.org/doc/html/rfc1112) - IP å¤šæ’­

### åº“æ–‡æ¡£

- [Tokio å®˜æ–¹æ–‡æ¡£](https://tokio.rs/)
- [socket2 æ–‡æ¡£](https://docs.rs/socket2/)
- [clap æ–‡æ¡£](https://docs.rs/clap/)

---

## é™„å½•: å¿«é€Ÿå‘½ä»¤å‚è€ƒ

```bash
# æ„å»ºæ•´ä¸ªé¡¹ç›®
cargo build

# æ„å»ºç‰¹å®š crate
cargo build -p discovery

# è¿è¡Œæµ‹è¯•
cargo test

# è¿è¡Œç¤ºä¾‹
cargo run --example test_discovery -p discovery
cargo run --example test_session -p session

# æŸ¥çœ‹ä¾èµ–æ ‘
cargo tree

# æ ¼å¼åŒ–ä»£ç 
cargo fmt

# ä»£ç æ£€æŸ¥
cargo clippy
```




